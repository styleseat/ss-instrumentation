# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

jobs:
  toxtest:
    docker:
      - image: themattrix/tox
    steps:
      - checkout
      - run: pip install tox
      - run: tox

  deploy_stage:
    docker:
      - image: cimg/node:14.14
    steps:
      - checkout
      - run: npm install -g serverless
      - run: npm install serverless-python-requirements
      - run: REDIS_HOST="$STAGE_REDIS_HOST" AWS_METRIC_NAMESPACE="stage" serverless deploy

  deploy_prod:
    docker:
      - image: cimg/node:14.14
    steps:
      - checkout
      - run: npm install -g serverless
      - run: npm install serverless-python-requirements
      - run: REDIS_HOST="$PROD_REDIS_HOST" AWS_METRIC_NAMESPACE="prod" serverless deploy

workflows:
  test:
    jobs:
      - toxtest
      - merge_hold:
          type: approval
          filters:
            branches:
              only:
                - master
      - deploy_stage:
          requires:
            - merge_hold
          filters:
            branches:
              only:
                - master
      - deploy_prod:
          requires:
            - merge_hold
          filters:
            branches:
              only:
                - master
