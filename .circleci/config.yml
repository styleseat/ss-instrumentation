# yamllint disable rule:line-length

# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

jobs:
  toxtest:
    docker:
      - image: themattrix/tox
    steps:
      - checkout
      # - run: pip install tox
      # - run: tox

  release:
    docker:
      - image: cimg/node:14.14
    steps:
      - checkout
      - run: sudo apt update && sudo apt install software-properties-common && sudo add-apt-repository ppa:deadsnakes/ppa
      - run: sudo apt install python3-pip && sudo apt install python3.8 && python3.8 -m pip install pip
      - run: |
          set -euxo pipefail

          git config --global user.name "CircleCI"
          git config --global user.email "engineering@styleseat.com"

          VERSION=$(python3 setup.py --version)

          # Update release branch
          git checkout release
          git reset --hard origin/release
          git merge --no-edit origin/dev
          git merge --no-edit origin/voy-610
          git commit --amend -m "v$VERSION [skip ci]"

          # Create tag
          git tag "v$VERSION"
          git push origin "v$VERSION"
          git push origin release

          # Merge back to dev branch
          git checkout dev
          git reset --hard origin/dev
          git merge --no-edit --no-commit origin/release
          git push origin dev

  deploy_stage:
    docker:
      - image: cimg/node:14.14
    steps:
      - checkout
      - run: sudo apt update && sudo apt-get -y install software-properties-common && sudo add-apt-repository -y ppa:deadsnakes/ppa
      - run: sudo apt-get -y install python3-pip python3.8 && python3.8 -m pip install pip
      - run:
          name: Serverless Deploy (stage)
          command: |
            export REDIS_HOST="$STAGE_REDIS_HOST"
            export AWS_METRIC_NAMESPACE="stage"
            export AWS_ACCESS_KEY_ID="$CIRCLECI_AWS_ACCESS_KEY_ID"
            export AWS_SECRET_ACCESS_KEY="$CIRCLECI_AWS_SECRET_ACCESS_KEY"
            npm run deploy -- --stage stage

  deploy_prod:
    docker:
      - image: cimg/node:14.14
    steps:
      - checkout
      - run: sudo apt update && sudo apt-get -y install software-properties-common && sudo add-apt-repository -y ppa:deadsnakes/ppa
      - run: sudo apt-get -y install python3-pip python3.8 && python3.8 -m pip install pip
      - run: npm ci
      - run:
          name: Serverless Deploy (prod)
          command: |
            export REDIS_HOST="$PROD_REDIS_HOST"
            export AWS_METRIC_NAMESPACE="prod"
            export AWS_ACCESS_KEY_ID="$CIRCLECI_AWS_ACCESS_KEY_ID"
            export AWS_SECRET_ACCESS_KEY="$CIRCLECI_AWS_SECRET_ACCESS_KEY"
            npm run deploy -- --stage prod

workflows:
  version: 2
  ss_instrumentation:
    jobs:
      - toxtest
      - release_hold:
          type: approval
          requires:
            - toxtest
          filters:
            branches:
              only:
                - dev
                - voy-610
      - release:
          requires:
            - release_hold
          context:
            - global
          filters:
            branches:
              only:
                - dev
                - voy-610
      - deploy_hold:
          type: approval
          requires:
            - toxtest
          filters:
            branches:
              only:
                - release
      - deploy_stage:
          requires:
            - deploy_hold
          context:
            - global
          filters:
            branches:
              only:
                - release
      - deploy_prod:
          requires:
            - deploy_hold
          context:
            - global
          filters:
            branches:
              only:
                - release
